<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Create and Validate a Choice List in a Symfony 2 Form</title>
  <meta name="description" content="There is a lot of magic going on in the Symfony 2 form component, and while this magic is frequently convenient and borderline awe-inspiring, it sometimes ha...">

  <link rel="canonical" href="/2011/08/create-and-validate-a-choice-list-in-a-symfony-2-form.html">
</head>


  <body>

    <div class="content page row">

      <article class="document col" itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">Create and Validate a Choice List in a Symfony 2 Form</h1>
    <h2><time datetime="2011-08-16T15:00:56-04:00" itemprop="datePublished">August 2011</time></h2>
  </header>

  <section itemprop="articleBody">
    <p>There is a lot of magic going on in the Symfony 2 form component, and while this magic is frequently convenient and borderline awe-inspiring, it sometimes has the unpleasant side effect of making it unclear how to do more fine-grained tasks within the form.  A standard select list can be created using Symfony’s <a href="http://symfony.com/doc/current/reference/forms/types/choice.html">choice</a> field type; it is pretty clear how to create a new choice field with simple, non-dynamic options (e.g. gender), but it gets a little more complicated when you want to create and validate a dynamically generated choice list.</p>

<p>When creating your choice field, you can specify which options are available by either passing an array of options (“choices”) or by passing a custom object that implements \Symfony\Component\Form\Extension\Core\ChoiceList\ChoiceListInterface (“choice_list”).  For this article, I will be focussing on the latter, but this can all be very easily adapted to a simple choices array.</p>

<h2 id="choice-lists-and-doctrine-2-entities">Choice Lists and Doctrine 2 Entities</h2>
<p>If the model that you bind to your form type is a doctrine 2 entity, then chances are the vast majority of your choice field’s form logic will be taken care of for you.  If you add a form field that matches an entity property that has an association to another entity, then Symfony guesses the correct form field type, retrieves the form field options, and even validates your input to make sure it is a valid option.  It is, for the lack of a better term, awesome:</p>

<p>We’ll need an entity:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\\ORM\\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**
 * @ORM\\Entity
 */</span>
<span class="k">class</span> <span class="nc">Post</span>
<span class="p">{</span>
    <span class="c1">// ... other post properties
</span>
    <span class="sd">/**
     * @ORM\\ManyToOne(targetEntity="Epixa\\Entity\\Category")
     */</span>
    <span class="k">protected</span> <span class="nv">$category</span><span class="p">;</span>

    <span class="c1">// ... appropriate getters an setters
</span><span class="p">}</span></code></pre></figure>

<p>We’ll also need a form type:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Form\\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\\Component\\Form\\AbstractType</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\FormBuilder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PostType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ... add other appropriate form fields
</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'category'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDefaultOptions</span><span class="p">(</span><span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'data_class'</span> <span class="o">=&gt;</span> <span class="s1">'Epixa\\Entity\\Post'</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'epixa_post'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Tie it all together with your action:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">addAction</span><span class="p">(</span><span class="nv">$topicId</span><span class="p">,</span> <span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$post</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\\Epixa\\Entity\\Post</span><span class="p">(</span><span class="nv">$topic</span><span class="p">);</span>

    <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">\\Epixa\\Form\\Type\\PostType</span><span class="p">(),</span> <span class="nv">$post</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bindRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// ... persist the $post in the db and redirect away
</span>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">()</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>With that code in place, your form will have a select field that lists all categories as options, and validation will ensure that not only is a category provided but also that the category is one of the available options.  <em>Note: your category entity will need to have a __toString() method defined as this is used as the human-readable component of a select option.</em></p>

<h2 id="creating-and-validating-non-entity-models">Creating and Validating Non-Entity Models</h2>
<p>Sometimes it is necessary to use a model in your form type that is not itself a Doctrine entity.  Personally, I have encountered this mostly when dealing with deletion forms.  Consider this scenario: let’s say you are adding functionality to delete a specific Category entity (the same category that is referenced in our previous Post example), but in order to delete a category, you need to choose where all of its child posts should be moved.  In this case, you want to display a select field with all possible categories, but you don’t have the wonderful benefits of a doctrine entity with an association defined.</p>

<p>In this situation, create a new model to represent your deletion parameters, attach it to a form that is designed to render and validate the available parameters, and then use that model to perform the necessary business logic to move the child posts and delete the category.  Again, let’s go with an example.</p>

<p>The model here is a little more complex than the previous entity; pay careful attention to the “assert” annotations that I use here:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Epixa\\Entity\Category</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Validator\\Constraints</span> <span class="k">as</span> <span class="nx">Assert</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\Extension\\Core\\ChoiceList\\ChoiceListInterface</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Validator\\ExecutionContext</span><span class="p">;</span>

<span class="sd">/**
 * @Assert\\Callback(methods = {"isInheritingCategoryValid"})
 */</span>
<span class="k">class</span> <span class="nc">CategoryDeletionParams</span>
<span class="p">{</span>
    <span class="sd">/**
     * @Assert\\NotBlank()
     */</span>
    <span class="k">protected</span> <span class="nv">$inheritingCategoryId</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$choices</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setInheritingCategoryId</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">inheritingCategoryId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$id</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInheritingCategoryId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">inheritingCategoryId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setInheritingCategoryChoices</span><span class="p">(</span><span class="nx">ChoiceListInterface</span> <span class="nv">$choices</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">choices</span> <span class="o">=</span> <span class="nv">$choices</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInheritingCategoryChoices</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">choices</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isInheritingCategoryValid</span><span class="p">(</span><span class="nx">ExecutionContext</span> <span class="nv">$context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$choiceList</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getInheritingCategoryChoices</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$choiceList</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\LogicException</span><span class="p">(</span><span class="s1">'No choice list configured'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$choices</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getInheritingCategoryChoices</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getChoices</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getInheritingCategoryId</span><span class="p">(),</span> <span class="nv">$choices</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$propertyPath</span> <span class="o">=</span> <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">getPropertyPath</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'.inheritingCategoryId'</span><span class="p">;</span>
            <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">setPropertyPath</span><span class="p">(</span><span class="nv">$propertyPath</span><span class="p">);</span>
            <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">addViolation</span><span class="p">(</span><span class="s1">'Invalid category'</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The NotBlank assertion on the $inheritingCategoryId ensures that a category id is required.  The Callback assertion on the class ensures that the given category id is actually one of the available options.  <em>Note: Callback assertions cannot be placed on properties.</em></p>

<p>Now for the form type:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Form\\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\\Component\\Form\\AbstractType</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\FormBuilder</span><span class="p">,</span>
    <span class="nx">Epixa\\Model\\CategoryDeletionParams</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DeleteCategoryType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span> <span class="nx">instanceof</span> <span class="nx">CategoryDeletionParams</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\LogicException</span><span class="p">(</span><span class="s1">'No valid options provided'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$deletionParams</span> <span class="o">=</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">'data'</span><span class="p">];</span>

        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'inheritingCategoryId'</span><span class="p">,</span> <span class="s1">'choice'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'Move all posts to:'</span><span class="p">,</span>
            <span class="s1">'choice_list'</span> <span class="o">=&gt;</span> <span class="nv">$deletionParams</span><span class="o">-&gt;</span><span class="na">getInheritingCategoryChoices</span><span class="p">()</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDefaultOptions</span><span class="p">(</span><span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'data_class'</span> <span class="o">=&gt;</span> <span class="s1">'Epixa\\Model\\CategoryDeletionParams'</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'epxia_delete_category'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In this form type, we have to do a little more leg work than we did before.  The form builder doesn’t have enough information to guess all of the field’s details like it did with the doctrine entity, so we needed to specify that this is a “choice” field, with a custom label, and populated by a specific choice_list.</p>

<p>Next up?  You guessed it; the action:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">deleteAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ... retrieve $category entity that matches the $id
</span>
    <span class="c1">// This should be located in its own service. I am including it here to get the message across.
</span>    <span class="nv">$entityName</span> <span class="o">=</span> <span class="s1">'Epixa\\Entity\\Category'</span><span class="p">;</span>
    <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nv">$entityName</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">'c'</span><span class="p">);</span>
    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'c.id &lt;&gt; :category_id'</span><span class="p">);</span> <span class="c1">// we don't want to include the category we're deleting
</span>    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">'category_id'</span><span class="p">,</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
    <span class="nv">$choiceList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\\Symfony\\Bridge\\Doctrine\\Form\\ChoiceList\\EntityChoiceList</span><span class="p">(</span><span class="nv">$em</span><span class="p">,</span> <span class="nv">$entityName</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">$qb</span><span class="p">);</span>

    <span class="nv">$deletionParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\\Epixa\\Model\\CategoryDeletionParams</span><span class="p">();</span>
    <span class="nv">$deletionParams</span><span class="o">-&gt;</span><span class="na">setInheritingCategoryChoices</span><span class="p">(</span><span class="nv">$choiceList</span><span class="p">);</span>

    <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">\\Epixa\\Form\\Type\\DeleteCategoryType</span><span class="p">(),</span> <span class="nv">$deletionParams</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bindRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// ... move all child posts to the category identified by $deletionParams-&gt;getInheritingCategoryId()
</span>            <span class="c1">// ... delete $category and redirect away
</span>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">()</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The controller above is a little rough.  I included a lot of logic in there that should really go into a separate service, but I didn’t want the complication of the example getting in way of the meat of the issue.</p>

<p>That’s it!  When you render the form, it will provided a Symfony 2 choice field rendered as a select field that is populated with all of the categories (except the one we’re deleting).  When you submit the form, it will check to make sure that not only is a category selected but also that the selection is actually one of the categories in the system.</p>

<p>I’m still only breaking the surface of the Symfony 2 form component, and I am finding that for all of incredible convenience that is provided for very common functionality there is likely an equal amount of frustration when trying to implement more specific pieces of functionality.  That said, the component is certainly powerful, and I haven’t yet come across a scenario that it couldn’t handle.</p>

<p><strong>Know of an easier way to do this?</strong> By all means let me know!  I am eager to simplify processes like this as I expect to be doing this kind of thing frequently.</p>

<h2 id="edit-aug-08-2010-440pm">Edit (Aug 08 2010 4:40pm):</h2>

<p><a href="http://webmozarts.com/">@Bernhard</a> has provided an approach that seems to be much more in line with the usage that symfony devs envisioned.  He notes that the <a href="http://symfony.com/doc/current/reference/forms/types/entity.html">entity</a> field type takes care of validation for you and provides a convenient way to populate the select options as well.  I’ve revised his example code only so much as to fit with the previous examples and execute properly:</p>

<p>Deletion parameters model:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\\Component\\Validator\\Constraints</span> <span class="k">as</span> <span class="nx">Assert</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CategoryDeletionParams</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$targetCategory</span><span class="p">;</span>

    <span class="sd">/**
     * @Assert\\NotBlank()
     */</span>
    <span class="k">protected</span> <span class="nv">$inheritingCategory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// ... appropriate setters and getters
</span><span class="p">}</span></code></pre></figure>

<p>Form type:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Epixa\\Form\\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\\Component\\Form\\AbstractType</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\FormBuilder</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\FormEvents</span><span class="p">,</span>
    <span class="nx">Symfony\\Component\\Form\\Event\\DataEvent</span><span class="p">,</span>
    <span class="nx">Doctrine\\ORM\\EntityRepository</span><span class="p">,</span>
    <span class="nx">Epixa\\Model\\CategoryDeletionParams</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DeleteCategoryType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// creates the inheriting select field whenever the data (deletion params model) is set
</span>        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span><span class="nx">FormEvents</span><span class="o">::</span><span class="na">PRE_SET_DATA</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">DataEvent</span> <span class="nv">$event</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$builder</span><span class="p">){</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data</span> <span class="nx">instanceof</span> <span class="nx">CategoryDeletionParams</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span> <span class="c1">// $data is null when form is first constructed
</span>            <span class="p">}</span>

            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getForm</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'inheritingCategory'</span><span class="p">,</span> <span class="s1">'entity'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'Move all posts to:'</span><span class="p">,</span>
                <span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="s1">'Epixa\\Entity\\Category'</span><span class="p">,</span>
                <span class="s1">'query_builder'</span> <span class="o">=&gt;</span> <span class="k">function</span><span class="p">(</span><span class="nx">EntityRepository</span> <span class="nv">$repo</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$data</span><span class="p">){</span>
                    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$repo</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">'c'</span><span class="p">);</span>
                    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'c.id &lt;&gt; :category_id'</span><span class="p">);</span>
                    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="err">‘</span><span class="nx">category_id</span><span class="err">’</span><span class="p">,</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">getTargetCategory</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
                    <span class="k">return</span> <span class="nv">$qb</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">))</span><span class="o">-&gt;</span><span class="na">getForm</span><span class="p">());</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// ...
</span><span class="p">}</span></code></pre></figure>

<p>Action:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">deleteAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ... retrieve $category that matches $id
</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\\Epixa\\Model\\CategoryDeletionParams</span><span class="p">(</span><span class="nv">$category</span><span class="p">);</span>
    <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">\\Epixa\\Form\\Type\\DeleteCategoryType</span><span class="p">(),</span> <span class="nv">$params</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bindRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// ... move child posts to inheriting category, delete target category, redirect away
</span>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">()</span>
    <span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>I think this approach is much clearer than my original example.  Thanks Bernhard!</p>

  </section>

</article>


    </div>

  </body>

</html>
