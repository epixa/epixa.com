<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>The Best Models are Easy Models</title>
  <meta name="description" content="Models are one of the most important building blocks to any well-formed application, but a few common misconceptions persist throughout the development commu...">

  <link rel="canonical" href="/2010/05/the-best-models-are-easy-models.html">
</head>


  <body>

    <div class="content page row">

      <article class="document col" itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">The Best Models are Easy Models</h1>
    <h2><time datetime="2010-05-05T22:48:47-04:00" itemprop="datePublished">May 2010</time></h2>
  </header>

  <section itemprop="articleBody">
    <p>Models are one of the most important building blocks to any well-formed application, but a few common misconceptions persist throughout the development community that can make working with models excruciating.  A properly constructed model should not only be powerful, but it should be extremely easy to work with.</p>

<p>While models do contain specific data, they are far more than simple data structures.  They should contain all logic possible to manage, manipulate, and validate the correctness of data as it is updated.  By treating your models as nothing more than a place to dump your data, you are doing yourself and your application a severe disservice; your business logic is going to be scattered throughout the rest of your application, and you will have a progressively more difficult time as you try to maintain and build upon your existing system.  Do not fall into the <a href="http://www.martinfowler.com/bliki/AnemicDomainModel.html">anemic model</a> trap.</p>

<p>In addition, models should be independent of the data-access layer.  If I am modeling a blog article, the article should not know nor care to know whether it was created from a mysql database, an xml file, user input, or the divine spaghetti monster.  No matter how it was populated or where it was persisted, the blog article is a blog article, and that is all that is important.</p>

<p>To manage my data access, I am a huge proponent of <a href="http://www.doctrine-project.org">Doctrine 2</a>.  Of which, one of my favorite features is that my models are completely decoupled from Doctrine itself.  This means there is no base model class that defines a ton of functionality for interacting with your data abstraction, so you have near endless flexibility when it comes to creating your models.  However, just because you are not <em>required</em> to extend a base record class does not mean that working with many of your models cannot be improved with some simple, abstract implementations.  Utilizing a simple abstract model and a few best practices can ensure your models remain incredibly versatile while still preserving the strict integrity of your data.</p>

<p>Let’s start with a simple blog article model:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Blog</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Epixa\AbstractModel</span><span class="p">;</span>

<span class="sd">/**
 * @Entity
 * @Table(name="blog_article")
 */</span>
<span class="k">class</span> <span class="nc">ArticleModel</span> <span class="k">extends</span> <span class="nx">AbstractModel</span>
<span class="p">{</span>
    <span class="sd">/**
     * @Id @Column(type="integer")
     * @GeneratedValue
     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**
     * @Column(type="string")
     */</span>
    <span class="k">protected</span> <span class="nv">$title</span><span class="p">;</span>

    <span class="sd">/**
     * @Column(type="date")
     */</span>
    <span class="k">protected</span> <span class="nv">$date</span><span class="p">;</span>

    <span class="sd">/**
     * @Column(type="text")
     */</span>
    <span class="k">protected</span> <span class="nv">$content</span><span class="p">;</span>

    <span class="sd">/**
     * For demonstration purposes only
     */</span>
    <span class="k">protected</span> <span class="nv">$_hiddenProperty</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>In our AbstractModel, we will utilize php’s magic methods to provide access to our entity properties in both a convenient and secure way.  All calls to retrieve a property’s value will map through an appropriate accessor if one exists, and all attempts to set an entity property will map through an appropriate mutator if one exists.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Blog</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">AbstractModel</span>
<span class="p">{</span>
    <span class="sd">/**
     * Map a call to get a property to its corresponding accessor if it exists.
     * Otherwise, get the property directly.
     *
     * Ignore any properties that begin with an underscore so not all of our
     * protected properties are exposed.
     *
     * @param  string $name
     * @return mixed
     * @throws \LogicException If no accessor/property exists by that name
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'_'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$accessor</span> <span class="o">=</span> <span class="s1">'get'</span><span class="o">.</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$accessor</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$accessor</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$name</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\LogicException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
            <span class="s1">'No property named `%s` exists'</span><span class="p">,</span>
            <span class="nv">$name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Map a call to set a property to its corresponding mutator if it exists.
     * Otherwise, set the property directly.
     *
     * Ignore any properties that begin with an underscore so not all of our
     * protected properties are exposed.
     *
     * @param  string $name
     * @param  mixed  $value
     * @return void
     * @throws \LogicException If no mutator/property exists by that name
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__set</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'_'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$mutator</span> <span class="o">=</span> <span class="s1">'set'</span><span class="o">.</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$mutator</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$mutator</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$name</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\LogicException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
            <span class="s1">'No property named `%s` exists'</span><span class="p">,</span>
            <span class="nv">$name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Map a call to a non-existent mutator or accessor directly to its
     * corresponding property
     *
     * @param  string $name
     * @param  array  $arguments
     * @return mixed
     * @throws \BadMethodCallException If no mutator/accessor can be found
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">'set'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$property</span> <span class="o">=</span> <span class="nb">lcfirst</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>

                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$property</span> <span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">);</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$property</span> <span class="o">=</span> <span class="nb">lcfirst</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>

                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$property</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\BadMethodCallException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
            <span class="s1">'No method named `%s` exists'</span><span class="p">,</span>
            <span class="nv">$name</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>With these simple methods, our protected entity properties are accessible like public properties, but individual models can ensure that their access and modification is still bound by filtering/validation through mutators and accessors.  Let’s implement some of these in our article model:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// ...
</span><span class="k">class</span> <span class="nc">ArticleModel</span> <span class="k">extends</span> <span class="nx">AbstractModel</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>
    <span class="sd">/**
     * Constructor
     *
     * Set the date to right now
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setDate</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @throws \BadMethodCallException Every time
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\BadMethodCallException</span><span class="p">(</span><span class="s1">'Cannot set article id directly'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Set the article title
     *
     * @param  string $title
     * @return ArticleModel *Provides fluid interface*
     * @throws \InvalidArgumentException If title is less than 3 characters
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$title</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$title</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="s1">'Title must be more than 3 chars'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="nv">$title</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Set the article date
     *
     * @param  mixed $date
     * @return ArticleModel *Provides fluid interface*
     * @throws \InvalidArgumentException If invalid date is given
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDate</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_int</span><span class="p">(</span><span class="nv">$date</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"@</span><span class="nv">$date</span><span class="s2">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$date</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="nv">$date</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$date</span> <span class="nx">instanceof</span> <span class="nx">\DateTime</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
                <span class="s1">'Expecting string, int or DateTime but `%s` given'</span><span class="p">,</span>
                <span class="nb">gettype</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span>
            <span class="p">));</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">date</span> <span class="o">=</span> <span class="nv">$date</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Get the article date in a human readable format
     *
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFormattedDate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">date</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">'F j, Y'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>With that, our article model filters and validates incoming and outgoing data.  Our article date is set immediately upon instantiation, the title is always trimmed and its length validated, the date can be set by multiple different types of values but is always stored as a DateTime, and we can utilize a convenience accessor (even as a property) to get the date formatted as a string.</p>

<p>If you are the type of developer that insists on having 100% data integrity in your models at all times, you could take this filtering and validation one step further by passing all required fields as arguments in the constructor.  On the other hand, if you’re like me you would abstract out the logic for handling data validation, so you could reuse the validation in forms that accept input from the user to populate your models and create a prePersist <a href="http://www.doctrine-project.org/documentation/manual/2_0/en/events#lifecycle-callbacks">lifecycle callback</a> (Doctrine only) that runs through the validation before a new model is persisted in the database.</p>

<p>To finish this up, here are some ad hoc examples of code using the ArticleModel:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$article</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog\ArticleModel</span><span class="p">();</span>

<span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="s1">'   My Article Title '</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>
<span class="c1">// outputs: My Article Title
</span>
<span class="nv">$article</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="s1">'My'</span><span class="p">;</span>
<span class="c1">// throws exception: Title must be more than 3 chars
</span>
<span class="nv">$article</span><span class="o">-&gt;</span><span class="na">date</span> <span class="o">=</span> <span class="s1">'yesterday'</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$article</span><span class="o">-&gt;</span><span class="na">formattedDate</span><span class="p">;</span>
<span class="c1">// outputs: May 5, 2010
</span>
<span class="k">echo</span> <span class="nv">$article</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="s1">'This is my content'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
<span class="c1">// outputs: This is my content
</span>
<span class="nv">$article</span><span class="o">-&gt;</span><span class="na">_hiddenProperty</span><span class="p">;</span>
<span class="o">//</span> <span class="nx">throws</span> <span class="nx">exception</span><span class="o">:</span> <span class="nx">No</span> <span class="nx">property</span> <span class="nx">named</span> <span class="sb">`_hiddenProperty`</span> <span class="nx">exists</span></code></pre></figure>

<h2 id="other-resources-about-models">Other Resources about Models</h2>

<ul>
  <li><a href="http://weierophinney.net/matthew/archives/202-Model-Infrastructure.html">Model Infrastructure - Matthew Weier O’Phinner</a></li>
  <li><a href="http://matthewturland.com/2010/03/26/models-in-zend-framework/">Models in Zend Framework - Matthew Turland</a></li>
</ul>


  </section>

</article>


    </div>

  </body>

</html>
