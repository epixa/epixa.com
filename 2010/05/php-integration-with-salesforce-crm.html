<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PHP Integration with Salesforce CRM</title>
  <meta name="description" content="If your primary clientele is small to medium business owners, as I imagine is the case for most professional developers these days, chances are you have deve...">

  <link rel="canonical" href="/2010/05/php-integration-with-salesforce-crm.html">
</head>


  <body>

    <div class="content page row">

      <article class="document col" itemscope itemtype="http://schema.org/BlogPosting">

  <header>
    <h1 itemprop="name headline">PHP Integration with Salesforce CRM</h1>
    <h2><time datetime="2010-05-18T22:18:28-04:00" itemprop="datePublished">May 2010</time></h2>
  </header>

  <section itemprop="articleBody">
    <p>If your primary clientele is small to medium business owners, as I imagine is the case for most professional developers these days, chances are you have developed custom applications that interact with Salesforce CRM.  For those of you that have not had the <em>delight</em> of integrating with Salesforce, let’s walk through the most common integration techniques.</p>

<p>Integrating with Salesforce CRM begins with the Force.com Web Services API.  The API is SOAP based, so you can use PHP’s built in soap extension to make calls to the service, but in this tutorial I’ll be using the <a href="http://wiki.developerforce.com/index.php/PHP_Toolkit">PHP Toolkit</a> provided by Salesforce; you still need to have the php soap extension installed, but the toolkit provides convenient utility methods for all of the available api calls.</p>

<h2 id="generate-your-wsdl">Generate your WSDL</h2>
<p>The first thing you’ll need to do to access your salesforce via the api is generate a WSDL.  The soap client requires the WSDL in order to, among other things, know what calls it can make to the server.</p>

<p>You have a few options when it comes to generating WSDLs in salesforce; I prefer to use the strongly typed Enterprise WSDL whenever possible.  Enter your salesforce ‘setup’ section, traverse to Develop &gt; API, and click the “Generate Enterprise WSDL” link (see screenshot below).  On the following step, just leave all the versions at the defaults and click the “Generate” button.  Save the XML that is generated into a new file in your application.</p>

<p><img src="/img/posts/salesforce-generate-wsdl.png" alt="Screenshot of salesforce setup for generating a wsdl" title="Salesforce: Generate WSDL" /></p>

<h2 id="get-your-security-token">Get your Security Token</h2>
<p>To access the soap service, you will need to provide your username, password, and the security token that is generated for your account.  The security token is a random 25 character string of uppercase and lowercase letters and numbers.  If you are not sure what your security token is, you can generate a new one through the salesforce ‘setup’ page (see screenshot below).  While you can reset your security token at any time, take heed of the notices that pepper the security-token section of the salesforce setup: if you change your security token, all existing api applications that rely on the token will break unless they are updated with the new token.</p>

<p><img src="/img/posts/salesforce-reset-security-token.png" alt="Screenshot of salesforce setup for resetting login security token" title="Salesforce: Reset Security Token" /></p>

<h2 id="get-your-code-on">Get your Code On</h2>
<p>Now that we have the boring salesforce groundwork out of the way, let’s write some code!  First up, get connected:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$wsdl</span>  <span class="o">=</span> <span class="s1">'enterprise-wsdl.xml'</span><span class="p">;</span>
<span class="nv">$user</span>  <span class="o">=</span> <span class="s1">'example@epixa.com'</span><span class="p">;</span>
<span class="nv">$pass</span>  <span class="o">=</span> <span class="s1">'supersecure'</span><span class="p">;</span>
<span class="nv">$token</span> <span class="o">=</span> <span class="s1">'fAjfS4FkxLsoqPxmsZujj0Szr'</span><span class="p">;</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SforceEnterpriseClient</span><span class="p">();</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">createConnection</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">);</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span> <span class="o">.</span> <span class="nv">$token</span><span class="p">);</span></code></pre></figure>

<p>The five core method calls that you <em>must</em> know are upsert, retrieve, getUpdated, delete, getDeleted.  There are <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_list.htm">many more</a>, but knowing these powerful five is sufficient to do a large number of synchronization scripts.</p>

<h2 id="sforceenterpriseclientupsert">SforceEnterpriseClient::upsert()</h2>
<p>While the Salesforce API does offer create() and update() methods, you will probably find yourself using this nifty function to accomplish either task: <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_upsert.htm">upsert()</a> will attempt to insert a new record, and if an existing record that matches the field you specify already exists, it will update that record instead.  For those familiar with MySQL, this is basically the equivalent of INSERT ON DUPLICATE KEY UPDATE.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$first</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span>
<span class="nv">$first</span><span class="o">-&gt;</span><span class="na">Name</span> <span class="o">=</span> <span class="s1">'First Epixa Widget'</span><span class="p">;</span>
<span class="nv">$first</span><span class="o">-&gt;</span><span class="na">Description</span> <span class="o">=</span> <span class="s1">'This Epixa Widget is the best product of all time!'</span><span class="p">;</span>

<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">upsert</span><span class="p">(</span><span class="s1">'Name'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$first</span><span class="p">),</span> <span class="s1">'Product2'</span><span class="p">);</span>
<span class="c1">// result: a new product is created in salesforce
</span>
<span class="nv">$second</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">();</span>
<span class="nv">$second</span><span class="o">-&gt;</span><span class="na">Name</span> <span class="o">=</span> <span class="s1">'Second Epixa Widget'</span><span class="p">;</span>
<span class="nv">$second</span><span class="o">-&gt;</span><span class="na">Description</span> <span class="o">=</span> <span class="s1">'No, THIS Widget is the best product of all time!'</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">upsert</span><span class="p">(</span><span class="s1">'Name'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$second</span><span class="p">),</span> <span class="s1">'Product2'</span><span class="p">);</span>
<span class="c1">// result: a new product is created in salesforce
</span>
<span class="nv">$clonedFirst</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$first</span><span class="p">;</span>
<span class="nv">$clonedFirst</span><span class="o">-&gt;</span><span class="na">Description</span> <span class="o">=</span> <span class="s1">'FINE, Second Widget.  You can be the best product.'</span><span class="p">;</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">upsert</span><span class="p">(</span><span class="s1">'Name'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$clonedFirst</span><span class="p">),</span> <span class="s1">'Product2'</span><span class="p">);</span>
<span class="o">//</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">the</span> <span class="nx">first</span> <span class="nx">object</span><span class="err">'</span><span class="nx">s</span> <span class="nx">description</span> <span class="nx">is</span> <span class="nx">updated</span> <span class="nx">in</span> <span class="nx">salesforce</span></code></pre></figure>

<h2 id="sforceenterpriseclientretrieve">SforceEnterpriseClient::retrieve()</h2>
<p>The core method <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_retrieve.htm">retrieve()</a> allows you to query for one or more of a specified Salesforce object given a set of unique Ids:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$ids</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'01tA0000000YU4D'</span><span class="p">,</span> <span class="s1">'01tA0000000YU48'</span><span class="p">);</span>

<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">retrieve</span><span class="p">(</span><span class="s1">'Id, Name, Description'</span><span class="p">,</span> <span class="s1">'Product2'</span><span class="p">,</span> <span class="nv">$ids</span><span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$results</span><span class="p">);</span>
<span class="c1">// results:
// Array
// (
//     [0] =&gt; stdClass Object
//         (
//             [Id] =&gt; 01tA0000000YU48IAG
//             [Description] =&gt; FINE, Second Widget.  You can be the best product.
//             [Name] =&gt; First Epixa Widget
//         )
//     [1] =&gt; stdClass Object
//         (
//             [Id] =&gt; 01tA0000000YU4DIAW
//             [Description] =&gt; No, THIS Widget is the best product of all time!
//             [Name] =&gt; Second Epixa Widget
//         )
</span><span class="o">//</span> <span class="p">)</span></code></pre></figure>

<h2 id="sforceenterpriseclientgetupdated">SforceEnterpriseClient::getUpdated()</h2>
<p>Whenever you are polling for data from Salesforce, <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_getupdated.htm">getUpdated()</a> is probably the method you’re going to use.  This will return an object that contains an array of all the unique Ids of objects that match the supplied type that were updated between the timestamps you pass it.  In addition to the array of Ids, the returned object also contains a timestamp in DATE_ATOM format of the last date covered in your getUpdated call that you can store and use for the start date in your next call to getUpdated().  Couple this with a call to retrieve(), and you can easily query for all objects updated since the last time your script ran.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">getUpdated</span><span class="p">(</span><span class="s1">'Product2'</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="s1">'-7 days'</span><span class="p">),</span> <span class="nb">time</span><span class="p">());</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$results</span><span class="p">);</span>
<span class="c1">// stdClass Object
// (
//     [ids] =&gt; Array
//         (
//             [0] =&gt; 01tA0000000YU48IAG
//             [1] =&gt; 01tA0000000YU4DIAW
//         )
//     [latestDateCovered] =&gt; 2010-05-19T00:29:00.000Z
</span><span class="o">//</span> <span class="p">)</span></code></pre></figure>

<h2 id="sforceenterpriseclientdelete">SforceEnterpriseClient::delete()</h2>
<p>This does not really require any explanation; however, it is worth noting that objects deleted through the <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_delete.htm">delete()</a> method are only logically deleted.  This will simply set the IsDeleted flag to true.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'01tA0000000YU4D'</span><span class="p">,</span> <span class="s1">'01tA0000000YU48'</span><span class="p">));</span>
<span class="o">//</span> <span class="nx">result</span><span class="o">:</span> <span class="nx">Two</span> <span class="nx">products</span> <span class="nx">with</span> <span class="nx">the</span> <span class="nx">passed</span> <span class="nx">Ids</span> <span class="nx">are</span> <span class="nx">marked</span> <span class="k">as</span> <span class="nx">deleted</span> <span class="nx">in</span> <span class="nx">salesforce</span></code></pre></figure>

<h2 id="sforceenterpriseclientgetdeleted">SforceEnterpriseClient::getDeleted()</h2>
<p>The method <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_getdeleted.htm">getDeleted()</a> is very similar to getUpdated() – it takes exactly the same parameters, but it returns a slightly different object.  The returned object still has the latestDateCovered property, but it also has an earliestDateAvailable property which is a DATE_ATOM formatted timestamp of the last physically deleted object.  Rather than having an array of Ids, the object returned by getDeleted() has an array of objects each with the Id of the deleted object and the timestamp of when that object was actually deleted.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">getDeleted</span><span class="p">(</span><span class="s1">'Product2'</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="s1">'-7 days'</span><span class="p">),</span> <span class="nb">time</span><span class="p">());</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$results</span><span class="p">);</span>
<span class="c1">// stdClass Object
// (
//     [deletedRecords] =&gt; Array
//         (
//             [0] =&gt; stdClass Object
//                 (
//                     [deletedDate] =&gt; 2010-05-19T02:38:31.000Z
//                     [id] =&gt; 01tA0000000YU48IAG
//                 )
//             [1] =&gt; stdClass Object
//                 (
//                     [deletedDate] =&gt; 2010-05-19T02:38:31.000Z
//                     [id] =&gt; 01tA0000000YU4DIAW
//                 )
//         )
//     [earliestDateAvailable] =&gt; 2010-03-12T01:13:00.000Z
//     [latestDateCovered] =&gt; 2010-05-19T00:29:00.000Z
</span><span class="o">//</span> <span class="p">)</span></code></pre></figure>

<h2 id="hold-up-there-are-some-gotchas">Hold up, there are some ‘gotchas’</h2>

<ol>
  <li>Calls to retrieve() do not always return an array of objects!  If only one result is returned, only that object will be returned.  I cannot begin to imagine who made this bonehead-decision, but it can be frustrating if you’re not expecting it.</li>
  <li>The PHP Toolkit handles some errors by throwing exceptions.  This is immensely convenient.  However, not all errors are thrown!  For methods such as create(), make sure you check the returned value for the property ‘errors’.  In addition to signifying that an error has occurred, the ‘errors’ object contains information that can be useful in debugging the issue.</li>
</ol>

<p>Integrating with Salesforce can be a frustrating experience, but it is hard to avoid if you work with any small to medium companies that take their CRM solutions seriously.  There are many more possibilities beyond what I outlined here, so I recommend that you familiarize yourself with the API documentation that I linked to throughout this article before beginning any Salesforce integration project.</p>

  </section>

</article>


    </div>

  </body>

</html>
